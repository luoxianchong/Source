# 一个Java对象占用内存大小

### 对象头

​		对象头包括两部分：Mark Word 和 类型指针.

##### Mark Word

Mark Word用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等等，占用内存大小与虚拟机位长一致。

##### 类型指针

类型指针指向对象的类元数据，虚拟机通过这个指针确定该对象是哪个类的实例。

##### 对齐填充字节

因为JVM要求java的对象占的内存大小应该是8bit的倍数，所以后面有几个字节用于把对象的大小补齐至8bit的倍数。



### 对象头形式

64bit

```ruby
普通对象：

|--------------------------------------------------------------|
|                     Object Header (128 bits)                  |
|------------------------------------|-------------------------|
|        Mark Word (64 bits)         |    Klass Word (64 bits) |
|------------------------------------|-------------------------|
    
数组：
|----------------------------------------------------------------------------------|
|                                 Object Header (192 bits)                         |
|--------------------------------|-----------------------|-------------------------|
|        Mark Word(64bits)       |    Klass Word(64bits) |  array length(64bits)   |
|--------------------------------|-----------------------|-------------------------|
```



### Mark Word

##### 64bit

```
|-------------------------------------------------------------------------------|--------------------|
|                                  Mark Word (64 bits)                          |       State        |
|-------------------------------------------------------------------------------|--------------------|
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2  |       Normal       |
|-------------------------------------------------------------------------------|--------------------|
| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1  | lock:2 |       Biased       |
|-------------------------------------------------------------------------------|--------------------|
|                       ptr_to_lock_record:62                         | lock:2  | Lightweight Locked |
|-------------------------------------------------------------------------------|--------------------|
|                     ptr_to_heavyweight_monitor:62                   | lock:2  | Heavyweight Locked |
|-------------------------------------------------------------------------------|--------------------|
|                                                                     | lock:2  |    Marked for GC   |
|-------------------------------------------------------------------------------|--------------------|
```





<table>
   <tr>
      <td  rowspan="2">锁状态</td>
      <td>25bit</td>
      <td  colspan="2">31bit</td>
      <td  rowspan="2">1bit</td>
      <td  rowspan="2">4bit</td>
      <td  rowspan="2">1bit</td>
      <td  rowspan="2">2bit</td>
   </tr>
   <tr>
      <td colspan="2">54bit</td>
      <td>2bit</td>
   </tr>
   <tr>
      <td>无锁</td>
      <td>unused</td>
      <td>hashcode</td>
      <td>hashcode</td>
      <td>unused</td>
      <td>分代年龄</td>
      <td>0</td>
      <td>01</td>
   </tr>
   <tr>
      <td>偏向锁</td>
      <td colspan="2">当前线程指针 javathread*</td>
      <td>Epoch</td>
      <td>unused</td>
      <td>分代年龄</td>
      <td>1</td>
      <td>01</td>
   </tr>
   <tr>
      <td>轻量级锁</td>
      <td colspan="6">指向线程的Lock Record的指针</td>
      <td>00</td>
   </tr>
   <tr>
      <td>重量级锁</td>
      <td colspan="6">指向互斥量的指针</td>
      <td>10</td>
   </tr>
   <tr>
      <td>GC标记</td>
      <td colspan="6">CMS过程用到的标记信息</td>
      <td>11</td>
   </tr>
</table>

![](E:\201320180110\source\image\64bit-MarkWord.png)



##### 32bit

```ruby
|-------------------------------------------------------|--------------------|
|                  Mark Word (32 bits)                  |       State        |
|-------------------------------------------------------|--------------------|
| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|-------------------------------------------------------|--------------------|
|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|-------------------------------------------------------|--------------------|
|               ptr_to_lock_record:30          | lock:2 | Lightweight Locked |
|-------------------------------------------------------|--------------------|
|               ptr_to_heavyweight_monitor:30  | lock:2 | Heavyweight Locked |
|-------------------------------------------------------|--------------------|
|                                              | lock:2 |    Marked for GC   |
|-------------------------------------------------------|--------------------|
```





<table>
   <tr>
      <td rowspan="2">锁状态</td>
      <td colspan="2">25bit</td>
      <td rowspan="2">4bit</td>
      <td>1bit</td>
      <td>2bit</td>
   </tr>
   <tr>
      <td>23bit</td>
      <td>2bit</td>
      <td>是否偏向锁</td>
      <td>锁标志位</td>
   </tr>
   <tr>
      <td>无锁</td>
      <td colspan="2">对象的HashCode</td>
      <td>分代年龄</td>
      <td>0</td>
      <td>01</td>
   </tr>
   <tr>
      <td>偏向锁</td>
      <td>线程ID</td>
      <td>Epoch</td>
      <td>分代年龄</td>
      <td>1</td>
      <td>01</td>
   </tr>
   <tr>
      <td>轻量级锁</td>
      <td colspan="4">指向栈中锁记录的指针</td>
      <td>00</td>
   </tr>
   <tr>
      <td>重量级锁</td>
      <td colspan="4">指向栈中锁记录的指针</td>
      <td>10</td>
   </tr>
   <tr>
      <td>GC标记</td>
      <td colspan="4"></td>
      <td>11</td>
   </tr>
</table>

![](E:\201320180110\source\image\32bit-markwork.png)



##### 说明：

​			**epoch：** 保存偏向时间戳

​			**ptr_to_heavyweight_monitor**：指向管程Monitor的指针



### 类型指针

 	用于存储对象的类型指针，该指针指向它的类元数据，JVM通过这个指针确定对象是哪个类的实例。该指针的位长度为JVM的一个字大小，即32位的JVM为32位，64位的JVM为64位。
 如果应用的对象过多，使用64位的指针将浪费大量内存，统计而言，64位的JVM将会比32位的JVM多耗费50%的内存。为了节约内存可以使用选项 `  -XX:+UseCompressedOops  `开启指针压缩，其中，oop即ordinary object pointer普通对象指针。开启该选项后，下列指针将压缩至32位：

1. 每个Class的属性指针（即静态变量）
2. 每个对象的属性指针（即对象变量）
3. 普通对象数组的每个元素指针

当然，也不是所有的指针都会压缩，一些特殊类型的指针JVM不会优化，比如指向PermGen的Class对象指针(JDK8中指向元空间的Class对象指针)、本地变量、堆栈元素、入参、返回值和NULL指针等。



##### 说明：

  			jdk8 和jdk7 默认开启指针压缩

### 数组长度（array length）

如果对象是一个数组，那么对象头还需要有额外的空间用于存储数组的长度，这部分数据的长度也随着JVM架构的不同而不同：32位的JVM上，长度为32位；64位JVM则为64位。64位JVM如果开启`   -XX:+UseCompressedOops   `选项，**该区域长度也将由64位压缩至32位**。





### 基础数据类型所占内存

| boolean | byte    | short   | char    | int     | long    | float   | double  |
| ------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| 1 bytes | 1 bytes | 2 bytes | 2 bytes | 4 bytes | 8 bytes | 4 bytes | 8 bytes |





### java 锁升级

