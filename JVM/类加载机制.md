#### 类加载机制

##### 类加载的时机

![类的生命周期](..\image\class-load-process.png)

类的生命周期：加载、验证、准备、解析、初始化、使用、卸载。

其中 验证、准备、解析 统称为连接

立即初始化条件：

1、遇到new,getstatic,putstatic,invokestatic这四条字节码指令；

​	①new 一个对象，

​	②读取或设置一个类的静态字段（final修饰除外，因已在常量池中）

​	③调用类的静态方法时

2、使用反射对类进行调用时

3、初始化子类时，父类未初始化；会先初始化父类；

4、执行类的main方法

5、jdk的动态语言支持。

**notice:**数组不是通过类加载器加载的，而是通过jvm直接创建的。数组它是一个类

##### 类的加载过程

###### 	1、加载

​		①通过全类限定名读取此类的二进制字节流

​		②将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构

​		③在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。

加载完成后类的二进制字节流按照jvm所需格式存储在方法区中，Class对象是个特殊的对象，Class对象方法方法区中。

###### 	2、验证

​		加载与连接阶段是交叉进行的。还未加载完，连接可能已经开始。

​		如果验证异常会抛出一个java.lang.VerifyError或其子类。

​		主要验证：

​			①文件格式验证：魔数0xCAFEBABE；jdk主次版本，比如jdk1.7是51，jdk1.8是52;常量...

​			②元数据验证：此类是否有父类；父类是否继承了final修饰的类；此类非抽象类，是否实现所有抽象方法；类中自动、方法是否与父类矛盾。语义检查

​			③字节码验证：数据与控制流的语义检查

​			④符号引用验证：根据全类限定名能否找到对应的类；字段、方法、类修饰符是否正确。

###### 	3、准备

​		准备阶段主要为类变量分配内存、设置初始值。变量的分配都是在方法区中进行，而这些变量是类的变量，不是实例变量。例如静态变量。初始值是指准备阶段类型的初始值，

比如：static int i=12,该值是0而不是12；把i赋值为12的putstatic指令是程序被编译后，存放于类构造器<clinit>()方法之中，所以把i赋值为12的动作将在初始化阶段才会执行。

如果变量被final修饰在准备阶段会为其初始化值12

###### 	4、解析

###### 5、初始化

######  6、使用

###### 7、卸载

